<!-- filepath: c:\Users\Mohamed\Desktop\FinSolutions\views\auth\forgot-password.ejs -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Forgot Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md bg-white shadow-lg rounded-2xl p-8">

        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Forgot Password</h1>

        <!-- Step 1: Enter Email -->
        <div id="step-email" class="<%= !showCodeStep ? '' : 'hidden' %>">
            <form id="emailForm" action="/auth/forgot-password" method="POST" class="space-y-4">
                <p class="text-gray-600 text-sm mb-2">Enter your email to receive a reset code</p>
                <input type="email" name="email" placeholder="Your email" value="<%= email %>"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required>
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    Send Code
                </button>
            </form>
        </div>

        <!-- Step 2: Enter Code -->
        <div id="step-code" class="<%= showCodeStep ? '' : 'hidden' %>">
            <div class="space-y-4">
                <p class="text-gray-600 text-sm mb-2">
                    Check your email for the code. You have <span id="timer">30</span> seconds.
                </p>
                <input type="text" id="code" placeholder="Enter code" maxlength="6"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required>
                <button type="button" onclick="verifyCode('<%= typeof resetCode !== 'undefined' ? resetCode : '' %>')"
                    class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    Verify Code
                </button>
                <button type="button" onclick="goBackToEmail()"
                    class="w-full bg-gray-600 text-white font-semibold py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                    Back to Email
                </button>
            </div>
        </div>

        <!-- Step 3: Change Password -->
        <div id="changePassword" class="hidden">
            <form id="passwordForm" action="/auth/resetPassword" method="POST" class="space-y-4">
                <p class="text-gray-600 text-sm mb-2">
                    Enter your new password.
                </p>
                <input type="hidden" name="email" value="<%= email %>">
                <input type="password" name="password" placeholder="New Password"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required minlength="6">
                <input type="password" name="confirmPassword" placeholder="Confirm Password"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required minlength="6">
                <button type="submit"
                    class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    Reset Password
                </button>
            </form>
        </div>

    </div>

    <script>
        let codeValid = 120;
        let countdownInterval;

        // Start countdown timer
        function startCountdown() {
            const timerEl = document.getElementById('timer');
            if (!timerEl) return;
            
            countdownInterval = setInterval(() => {
                codeValid--;
                timerEl.textContent = codeValid;

                if (codeValid <= 0) {
                    clearInterval(countdownInterval);
                    showMessage('Code expired! Redirecting to login...', 'error');
                    setTimeout(() => {
                        window.location.href = "/auth/login";
                    }, 2000);
                }
            }, 1000);
        }

        // Go back to email step
        function goBackToEmail() {
            clearInterval(countdownInterval);
            window.location.href = "/auth/forgot-password";
        }

        // Show flash message
        function showMessage(text, type) {
            const flashMessages = [{ type, text }];
            if (typeof showFlashMessages === 'function') {
                showFlashMessages(flashMessages);
            } else {
                alert(text);
            }
        }

        // Verify code function - CLIENT SIDE ONLY
        function verifyCode(resetCode) {
            const code = document.getElementById('code').value.trim();

            if (!code) {
                showMessage('Please enter the code!', 'error');
                document.getElementById('code').focus();
                return;
            }

            if (code === resetCode) {
                clearInterval(countdownInterval);
                showMessage('Code verified successfully!', 'success');
                
                // Show password reset form
                document.getElementById('step-code').classList.add('hidden');
                document.getElementById('changePassword').classList.remove('hidden');
            } else {
                showMessage('Invalid code! Please try again.', 'error');
                document.getElementById('code').value = '';
                document.getElementById('code').focus();
            }
        }

        // Handle Enter key press on code input
        document.addEventListener('DOMContentLoaded', function() {
            const codeInput = document.getElementById('code');
            if (codeInput) {
                codeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const resetCode = '<%= typeof resetCode !== "undefined" ? resetCode : "" %>';
                        verifyCode(resetCode);
                    }
                });
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            // Start countdown if we're on the code step
            <% if (showCodeStep) { %>
                startCountdown();
            <% } %>

            // Handle flash messages
            const flashMessages = [];

            <% if (success_msg && success_msg.length > 0) { %>
                <% if (Array.isArray(success_msg)) { %>
                    <% success_msg.forEach(msg => { %>
                        flashMessages.push({ type: 'success', text: "<%= msg %>" });
                    <% }) %>
                <% } else { %>
                    flashMessages.push({ type: 'success', text: "<%= success_msg %>" });
                <% } %>
            <% } %>
            
            <% if (error_msg && error_msg.length > 0) { %>
                <% if (Array.isArray(error_msg)) { %>
                    <% error_msg.forEach(err => { %>
                        flashMessages.push({ type: 'error', text: "<%= typeof err === 'string' ? err : err.message %>" });
                    <% }) %>
                <% } else { %>
                    flashMessages.push({ type: 'error', text: "<%= error_msg %>" });
                <% } %>
            <% } %>

            if (flashMessages.length > 0 && typeof showFlashMessages === 'function') {
                showFlashMessages(flashMessages);
            }
        });
    </script>

    <!-- Import the JS file -->
    <script src="/js/flashMessages.js"></script>

</body>

</html>