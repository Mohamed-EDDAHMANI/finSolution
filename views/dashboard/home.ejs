<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Dashboard Utilisateur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-lg p-4 flex justify-between items-center">
        <div class="text-xl font-bold">FinSolution Finance</div>
        <div class="flex items-center gap-4">
            <% if (displayName) { %>
                <span>Bienvenue, <%= displayName %>!</span>
                <% } else { %>
                    <p>Bienvenue, Guest!</p>
                    <% } %>
                        <button id="logoutBtn"
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">
                            Déconnexion
                        </button>
        </div>
    </nav>

    <div class="container mx-auto mt-6 p-4">

        <!-- Solde actuel -->
        <div class="bg-white shadow rounded-lg p-6 mb-6 hover:shadow-lg transition">
            <h2 class="text-gray-500 text-sm">Solde Actuel</h2>
            <p class="text-3xl font-bold text-green-500">
                <%= (typeof balance !=='undefined' && balance !==null) ? balance.toFixed(2) : "0.00" %> MAD
            </p>
        </div>

        <div class="grid md:grid-cols-3 gap-6">

            <!-- Formulaire nouvelle transaction -->
            <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition">
                <h3 class="text-lg font-semibold mb-4">Ajouter une Transaction</h3>
                <form id="transactionForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700">Type</label>
                        <select class="w-full border rounded px-3 py-2" name="type">
                            <option value="income">Revenu</option>
                            <option value="expense">Dépense</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">Catégorie</label>
                        <select name="categoryId" class="w-full border rounded px-3 py-2">
                            <% categories.forEach(cat=> { %>
                                <option value="<%= cat.id %>">
                                    <%= cat.name %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">Montant</label>
                        <input type="number" class="w-full border rounded px-3 py-2" name="amount"
                            placeholder="Ex: 150">
                    </div>
                    <div>
                        <label class="block text-gray-700">Date</label>
                        <input type="date" class="w-full border rounded px-3 py-2" name="date">
                    </div>
                    <button type="submit"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full transition">Ajouter</button>
                </form>
            </div>

            <!-- Tableau transactions récentes -->
            <div class="bg-white shadow rounded-lg p-6 col-span-2 hover:shadow-lg transition">
                <h3 class="text-lg font-semibold mb-4">Transactions Récentes</h3>
                <table class="w-full text-left table-auto mb-4">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="px-4 py-2">Date</th>
                            <th class="px-4 py-2">Catégorie</th>
                            <th class="px-4 py-2">Montant</th>
                            <th class="px-4 py-2">Type</th>
                            <th class="px-4 py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        <% if (!transactions || transactions.length===0) { %>
                            <tr>
                                <td colspan="5" class="text-center text-gray-500 py-4">Aucune transaction
                                    disponible</td>
                            </tr>
                            <% } else { %>
                                <% transactions.forEach(trx=> { %>
                                    <tr class="border-b" data-id="<%= trx.id %>">
                                        <td class="px-4 py-2">
                                            <%= trx.date.toLocaleDateString('fr-FR') %>
                                        </td>
                                        <td class="px-4 py-2">
                                            <!-- <%= trx.categoryId %> -->
                                            <%= categories.find(cat => cat.id === trx.categoryId)?.name || 'N/A' %>
                                        </td>
                                        <td
                                            class="px-4 py-2 <%= trx.type === 'expense' ? 'text-red-500' : 'text-green-500' %>">
                                            <%= trx.type==='expense' ? '-' : '+' %>
                                                <%= trx.amount %> MAD
                                        </td>
                                        <td class="px-4 py-2">
                                            <%= trx.type==='expense' ? 'Dépense' : 'Revenu' %>
                                        </td>
                                        <td class="px-4 py-2">
                                            <button
                                                class="text-blue-500 hover:underline editTransaction">Éditer</button>
                                            <button
                                                class="text-red-500 hover:underline ml-2 deleteTransaction">Supprimer</button>
                                        </td>
                                    </tr>
                                    <% }) %>
                                        <% } %>
                    </tbody>
                </table>
                <button class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 transition">Exporter CSV</button>
            </div>
        </div>

        <!-- Budgets et Objectifs -->
        <div class="grid md:grid-cols-2 gap-6 mt-6">
            <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition">
                <h3 class="text-lg font-semibold mb-4">Budgets par Catégorie</h3>
                <ul class="space-y-3 mb-4" id="budgetList">
                    <% categories.forEach(cat=> { %>
                        <li class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                            <span>
                                <%= cat.name %> : <%= cat.current || 0 %> MAD / <%= cat.limit || 0 %> MAD
                            </span>
                            <div class="flex gap-2">
                                <button
                                    class="updateCategory bg-yellow-400 hover:bg-yellow-500 text-white px-2 py-1 rounded text-sm transition"
                                    data-id="<%= cat.id %>" data-name="<%= cat.name %>" data-limit="<%= cat.limit %>">
                                    Modifier
                                </button>
                                <button
                                    class="deleteCategory bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm transition"
                                    data-id="<%= cat.id %>">
                                    Supprimer
                                </button>
                            </div>
                        </li>
                        <% }) %>
                </ul>

                <!-- Formulaire Catégorie -->
                <form id="categoryForm" class="space-y-3 bg-gray-50 p-4 rounded-lg">
                    <input type="hidden" name="id" id="categoryId">
                    <div>
                        <label class="block text-gray-700">Nom de la Catégorie</label>
                        <input type="text" name="name" id="categoryName" placeholder="Ex: Santé"
                            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-gray-700">Limite (MAD)</label>
                        <input type="number" name="limit" id="categoryLimit" placeholder="Ex: 2000"
                            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <button type="submit" id="categorySubmitBtn"
                        class="bg-blue-500 text-white px-4 py-2 rounded w-full hover:bg-blue-600 transition">
                        Ajouter Catégorie
                    </button>
                </form>
            </div>

            <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition">
                <h3 class="text-lg font-semibold mb-4">Objectifs d'Épargne</h3>
                <ul class="list-disc pl-5 space-y-2">
                    <li>Vacances : 5000 MAD / 2000 MAD épargnés</li>
                    <li>Achat ordinateur : 7000 MAD / 1500 MAD épargnés</li>
                </ul>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="grid md:grid-cols-2 gap-6 mt-6">
            <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition">
                <h3 class="text-lg font-semibold mb-4">Répartition des Dépenses</h3>
                <canvas id="pieChart"></canvas>
            </div>
            <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition">
                <h3 class="text-lg font-semibold mb-4">Évolution Revenus/Dépenses</h3>
                <canvas id="lineChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        let flashMessages = [];

        // Charts
        const pieData = {
            labels: ['Alimentation', 'Transport', 'Loisirs', 'Autres'],
            datasets: [{
                data: [150, 200, 100, 50],
                backgroundColor: ['#f87171', '#60a5fa', '#34d399', '#fbbf24'],
            }]
        };
        new Chart(document.getElementById('pieChart'), { type: 'pie', data: pieData });

        const lineData = {
            labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil'],
            datasets: [{
                label: 'Dépenses',
                data: [1200, 900, 1400, 1100, 1300, 1000, 900],
                borderColor: '#f87171',
                fill: false,
            }, {
                label: 'Revenus',
                data: [3000, 3500, 3200, 4000, 3700, 3800, 3900],
                borderColor: '#34d399',
                fill: false,
            }]
        };
        new Chart(document.getElementById('lineChart'), { type: 'line', data: lineData });

        // Transaction Form AJAX
        const transactionForm = document.getElementById('transactionForm');
        const transactionsTable = document.getElementById('transactionsTable');

        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(transactionForm));

            try {
                const res = await fetch('/api/transactions/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
    
                if (!res.ok) {
                    if (Array.isArray(result.errors) && result.errors.length > 0) {
                        result.errors.forEach(item => {
                            flashMessages.push({ type: 'error', text: item.message || 'Erreur' });
                        });
                    } else {
                        flashMessages.push({ type: 'error', text: result.message || 'Erreur' });
                    }
                    showFlashMessages(flashMessages);
                    flashMessages = [];
                    return;
                }

                flashMessages.push({ type: 'success', text: "Transaction ajoutée avec succès !" });
                showFlashMessages(flashMessages);

                const row = document.createElement('tr');
                row.classList.add('border-b');
                row.dataset.id = result.id;
                row.innerHTML = `
                    <td class="px-4 py-2">${new Date(result.date).toLocaleDateString('fr-FR')}</td>
                    <td class="px-4 py-2">${result.categorie}</td>
                    <td class="px-4 py-2 ${result.type === 'depense' ? 'text-red-500' : 'text-green-500'}">
                        ${result.type === 'depense' ? '-' : '+'}${result.montant} MAD
                    </td>
                    <td class="px-4 py-2">${result.type === 'depense' ? 'Dépense' : 'Revenu'}</td>
                    <td class="px-4 py-2">
                        <button class="text-blue-500 hover:underline editTransaction">Éditer</button>
                        <button class="text-red-500 hover:underline ml-2 deleteTransaction">Supprimer</button>
                    </td>
                `;
                transactionsTable.prepend(row);
                transactionForm.reset();

            } catch (err) {
                flashMessages.push({ type: 'error', text: err.message });
                showFlashMessages(flashMessages);
                flashMessages = [];
            }
        });

        // Logout
        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", async () => {
            try {
                const res = await fetch("/auth/logout", {
                    method: "POST",
                    credentials: "include"
                });

                if (res.ok) {
                    window.location.href = "/auth/login";
                } else {
                    alert("Erreur lors de la déconnexion");
                }
            } catch (err) {
                console.error("Erreur logout:", err);
            }
        });

        // Flash from server
        window.addEventListener('DOMContentLoaded', () => {
            let serverFlash = [];

            <% if (success_msg && success_msg.length > 0) { %>
                serverFlash.push({ type: 'success', text: <%= JSON.stringify(success_msg) %> });
            <% } %>

            <% if (error_msg && error_msg.length > 0) { %>
                <% error_msg.forEach(err => { %>
                    serverFlash.push({ type: 'error', text: <%= JSON.stringify(err instanceof Error ? err.message : err) %> });
                <% }) %>
            <% } %>

            if (serverFlash.length > 0) {
                showFlashMessages(serverFlash);
                serverFlash = [];
            }
        });

        // =========================
        // CRUD Category Functions
        // =========================
        const categoryForm = document.getElementById('categoryForm');
        const categoryIdInput = document.getElementById('categoryId');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryLimitInput = document.getElementById('categoryLimit');
        const budgetList = document.getElementById('budgetList');

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const name = categoryNameInput.value.trim();
            const limit = Number(categoryLimitInput.value);

            // Validation côté client avec flash
            if (!name || isNaN(limit)) {
                flashMessages.push({ type: 'error', text: 'Nom et limite valides requis' });
                showFlashMessages(flashMessages);
                flashMessages = [];
                return;
            }

            try {
                const url = id ? `/api/categories/update/${id}` : '/api/categories/create';
                const method = id ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, limit }),
                    credentials: 'include'
                });

                const result = await res.json();

                // Erreur côté serveur
                if (!res.ok) {
                    if (Array.isArray(result.errors) && result.errors.length > 0) {
                        result.errors.forEach(item => {
                            flashMessages.push({ type: 'error', text: item.message || 'Erreur' });
                        });
                    } else {
                        flashMessages.push({ type: 'error', text: result.message || 'Erreur' });
                    }
                    showFlashMessages(flashMessages);
                    flashMessages = [];
                    return;
                }

                // Reset form
                categoryForm.reset();
                categoryIdInput.value = '';
                categorySubmitBtn.textContent = 'Ajouter Catégorie';

                // Message succès
                flashMessages.push({ type: 'success', text: result.message || 'Catégorie enregistrée avec succès' });
                showFlashMessages(flashMessages);
                flashMessages = [];

                // Refresh list
                setTimeout(() => window.location.reload(), 1000);

            } catch (err) {
                flashMessages.push({ type: 'error', text: err.message });
                showFlashMessages(flashMessages);
                flashMessages = [];
            }
        });



        budgetList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('updateCategory')) {
                const id = e.target.dataset.id;
                const name = e.target.dataset.name;
                const limit = e.target.dataset.limit;
                categoryIdInput.value = id;
                categoryNameInput.value = name;
                categoryLimitInput.value = limit;
                categorySubmitBtn.textContent = 'Modifier Catégorie';
            } else if (e.target.classList.contains('deleteCategory')) {
                const id = e.target.dataset.id;
                if (confirm('Voulez-vous supprimer cette catégorie ?')) {
                    try {
                        const res = await fetch(`/api/categories/delete/${id}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        const result = await res.json();

                        if (!res.ok) {
                            flashMessages.push({ type: 'error', text: result.message || 'Erreur' });
                            showFlashMessages(flashMessages);
                            flashMessages = [];
                            return;
                        }

                        flashMessages.push({ type: 'success', text: result.message || 'Catégorie supprimée avec succès' });
                        showFlashMessages(flashMessages);
                        flashMessages = [];

                        // Rafraîchir la liste après un petit délai pour voir le message
                        setTimeout(() => window.location.reload(), 1000);

                    } catch (err) {
                        flashMessages.push({ type: 'error', text: err.message });
                        showFlashMessages(flashMessages);
                        flashMessages = [];
                    }
                }
            }
        });


    </script>
    <script src="/js/flashMessages.js"></script>
</body>

</html>